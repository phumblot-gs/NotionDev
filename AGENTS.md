# AGENTS.md - notion_dev-project

*Generated by NotionDev on 2025-12-30 23:29*

---

# 1. CURRENT TASK

## Asana Ticket: ND03 - Implémenter le serveur MCP distant pour Product Owner

- **Task ID**: 1212583361132486
- **Feature Code**: ND03
- **Status**: In Progress
- **Asana URL**: https://app.asana.com/0/0/1212583361132486

## Task Description

### Feature Code
ND03

## Objectif

Déployer un serveur MCP sur fly.io permettant aux Product Owners d'utiliser NotionDev depuis Claude.ai en mode conversationnel.

Voir feature ND03 dans Notion pour les specs complètes.

---

## Phase 1 : Préparation infrastructure et comptes

### 1.1 Créer le compte de service Charly
- Créer le compte Google charly@grand-shooting.com
- Documenter les credentials

### 1.2 Créer les tokens de service
- Notion : Créer intégration NotionDev Service avec compte Charly
- Asana : Créer compte Asana pour Charly, générer PAT

### 1.3 Configurer Google OAuth
- Créer projet NotionDev MCP sur Google Cloud Console
- Configurer OAuth (domaine grand-shooting.com)

---

## Phase 2 : Développement serveur MCP

### 2.1 Support des deux modes (local stdio / distant SSE)
- Ajouter arguments CLI --transport, --port, --auth
- Créer config.py pour gérer les modes

### 2.2 Authentification
- Créer auth.py avec middleware Google OAuth
- Vérification domaine email configurable
- Génération/validation JWT

### 2.3 Nouveaux outils lecture de code
- notiondev_read_file
- notiondev_search_code
- notiondev_list_files
- notiondev_prepare_feature_context

### 2.4 Filtrer outils selon mode
- Désactiver check_installation, work_on_ticket, mark_done en distant
- Activer outils lecture code uniquement en distant

---

## Phase 3 : Déploiement fly.io

- Créer apps notiondev-staging et notiondev-prod
- Configurer secrets (tokens, OAuth)
- Créer fly.toml, Dockerfile
- Déployer staging puis prod

---

## Phase 4 : Documentation et tests

- Documenter config MCP distant Claude.ai
- Tester workflow PO complet
- Vérifier coexistence avec mode local ND02

---

## Ressources fly.io
- Staging: shared-cpu-1x, 512MB, 1GB vol (~5 USD/mois)
- Prod: shared-cpu-2x, 1GB, 5GB vol, auto-scale (~20-30 USD/mois)

---

## Definition of Done
- PO peut se connecter via Google OAuth
- PO peut lister/créer tickets, lire features, analyser code
- Actions tracées avec email PO
- Mode local ND02 sans régression

---

# 2. FEATURE SPECIFICATIONS

## Feature: ND03 - Serveur MCP distant pour Product Owner

- **Module**: NotionDev
- **Status**: Draft
- **Plans**: N/A
- **User Rights**: N/A

## Feature Documentation

## Serveur MCP distant pour Product Owner

### Description

Serveur MCP hébergé sur fly.io permettant aux Product Owners d'utiliser NotionDev depuis Claude.ai en mode conversationnel, sans accès à une console locale.

Cette feature est **complémentaire** à ND02 (MCP local en stdio). Les deux modes doivent coexister :

### Architecture

```plain text
┌─────────────────────────────────────┐
│            Claude.ai                │
│        (PO en conversation)         │
└────────────────┬────────────────────┘
                 │
                 │ HTTPS + JWT (Google OAuth)
                 ▼
┌─────────────────────────────────────┐
│         MCP Server (fly.io)         │
│                                     │
│  Transport: SSE (Server-Sent Events)│
│  Auth: Google OAuth                 │
│        domaine restreint            │
│                                     │
│  Tokens: Service account "Charly"   │
│          NOTION_TOKEN               │
│          ASANA_TOKEN                │
└─────────────────┬───────────────────┘
                  │
        ┌─────────┼─────────┐
        ▼         ▼         ▼
   ┌────────┐ ┌───────┐ ┌────────┐
   │ Notion │ │ Asana │ │ GitHub │
   └────────┘ └───────┘ └────────┘
```

### Coexistence ND02 / ND03

Le code du serveur MCP doit supporter les deux modes d'exécution :

```python
## Mode local (ND02) - stdio
python -m notion_dev.mcp_server.server

## Mode distant (ND03) - SSE avec auth
python -m notion_dev.mcp_server.server --transport sse --port 8000 --auth
```

#### Structure du code

```plain text
notion_dev/mcp_server/
├── server.py           # Serveur MCP (tools, prompts)
├── auth.py             # NEW: Middleware Google OAuth
├── config.py           # NEW: Config selon mode (local/distant)
└── code_tools.py       # NEW: Outils lecture code (clone, read, search)
```

#### Outils disponibles selon le mode

### Authentification

#### Google OAuth avec restriction de domaine

1. Le PO se connecte avec son compte Google `@grand-shooting.com`

1. Le serveur vérifie que le domaine est autorisé (configurable)

1. Un JWT est généré pour les requêtes suivantes

#### Configuration

```bash
## Variables d'environnement
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=xxx
ALLOWED_EMAIL_DOMAIN=grand-shooting.com  # Paramétrable
MCP_AUTH_ENABLED=true
```

#### Compte de service "Charly"

Un compte Google de service `charly@grand-shooting.com` est créé pour :

1. **Créer l'intégration Notion** → Token `NOTION_TOKEN`

1. **Créer le compte Asana** → Token `ASANA_TOKEN`

Avantages :

- Tokens non liés à une personne physique

- Pas de rotation quand un employé part

- Traçabilité claire (actions faites par "Charly" = via MCP)

### Nouveaux outils MCP (lecture de code)

#### notiondev_read_file

Lit le contenu d'un fichier dans un repo cloné.

```python
notiondev_read_file(module_prefix: str, file_path: str) -> str
```

#### notiondev_search_code

Recherche un pattern dans le code d'un module.

```python
notiondev_search_code(module_prefix: str, pattern: str, glob: str = "**/*") -> str
```

#### notiondev_list_files

Liste les fichiers d'un module avec filtrage glob.

```python
notiondev_list_files(module_prefix: str, glob_pattern: str = "**/*") -> str
```

#### notiondev_prepare_feature_context

Prépare un contexte de code agrégé pour une feature, prêt à être analysé par Claude.

```python
notiondev_prepare_feature_context(
    module_prefix: str,
    feature_code: str,
    max_total_lines: int = 2000
) -> str
```

Retourne :

- Fichiers primaires (contiennent le code feature)

- Fichiers secondaires (importent/utilisent)

- Résumé de l'arborescence

- Suggestions de fichiers à lire en détail

### Infrastructure fly.io

#### Environnements

#### Coût estimé

- Staging : ~$5/mois

- Production : ~$20-30/mois

#### Gestion du cache des repos

Les repos clonés sont stockés dans un volume persistant :

```plain text
/data/repos/
├── CC/           # TTL 1h après dernier accès
├── API/          # TTL 1h
└── .cache.json   # Métadonnées
```

Un job de nettoyage supprime les repos non utilisés pour libérer l'espace.

### Workflow typique Product Owner

```plain text
PO: "Je veux préparer le ticket pour améliorer CC01"

Claude: get_feature(CC01)
→ Specs Notion actuelles

Claude: prepare_feature_context(CC, CC01)
→ Code pertinent agrégé

Claude: [Analyse et compare specs vs implémentation]
"Voici ce qui est implémenté :
- Login email/password ✅
- Validation basique ✅
- 2FA ❌ (non implémenté)

Je suggère d'ajouter..."

PO: "Crée le ticket avec ces infos"

Claude: create_ticket(...)
→ Ticket créé avec Definition of Ready
```

### Sécurité

- HTTPS obligatoire

- JWT avec expiration courte (1h)

- Restriction domaine email configurable

- Tokens de service stockés en secrets fly.io (chiffrés)

- Logs d'accès avec email du PO pour traçabilité

---

# 3. MODULE DOCUMENTATION

## Module: NotionDev

CLI et serveur MCP pour l'intégration Notion ↔ Asana ↔ Git

## Technical Documentation

## NotionDev

### Objective

NotionDev is a Python CLI tool that integrates **Notion**, **Asana**, and **Git** for developers. It implements a **specs-first** methodology where all functional specifications are documented in Notion BEFORE coding.

#### Main Features

- **Notion → Code Sync**: Automatically loads feature specifications from Notion into `AGENTS.md`

- **Asana Integration**: Lists and manages assigned tickets with portfolio filtering

- **AI Context**: Generates context for AI assistants (Claude, Cursor, etc.)

- **Traceability**: Links code to specifications via feature codes (e.g., CC01, API02)

- **MCP Server**: Exposes functionality to Claude Code via Model Context Protocol

### Tech Stack

- **Language**: Python 3.10+

- **CLI Framework**: Click 8.1+

- **Terminal UI**: Rich 13.7+

- **Notion API**: notion-client 2.2+

- **Asana API**: requests (custom HTTP client)

- **Git**: GitPython 3.1+

- **Configuration**: PyYAML 6.0+

- **MCP Server**: mcp (FastMCP) - Python 3.10+

### Architecture

```plain text
notion_dev/
├── __init__.py              # Package init with version
├── cli/
│   └── main.py              # Click commands and Rich UI
├── core/
│   ├── asana_client.py      # Asana client (requests)
│   ├── config.py            # YAML config with dataclasses
│   ├── context_builder.py   # AGENTS.md context generation
│   ├── github_client.py     # GitHub repository cloning
│   ├── models.py            # Models (Module, Feature, AsanaTask, AsanaProject)
│   └── notion_client.py     # Notion client (official SDK)
├── mcp_server/
│   └── server.py            # MCP server (FastMCP) - wraps CLI commands
└── requirements.txt
```

#### Data Flow

1. **Asana** → Assigned tickets with feature code

1. **Notion** → Module and feature specifications

1. **NotionDev** → Aggregates and formats context

1. **AGENTS.md** → Context file for AI assistants

### Key Design Patterns

#### 1. Configuration Management

- YAML configuration stored in `~/.notion-dev/config.yml`

- Automatic project detection based on working directory

- Project-specific cache stored in `.notion-dev/` folders

- Environment variables override for all settings

#### 2. API Clients

- **AsanaClient**: Custom implementation using `requests` library (NOT the official SDK due to compatibility issues with Python 3.10+)

- **NotionClient**: Wrapper around official `notion-client` SDK

- **GitHubClient**: Handles repository cloning with shallow clone support

- All clients handle authentication and provide typed responses

#### 3. Data Models

- All data structures use Python `dataclasses` for type safety and validation

- Models: `Module`, `Feature`, `AsanaTask`, `AsanaProject`

- Automatic feature code extraction from ticket titles/notes (pattern: XX01, XX02, etc.)

#### 4. Multi-project Support

- Automatically detects current project from working directory

- Switches context based on repository path

- Caches project-specific data locally

#### 5. Workflow Integration

- Links: Asana tickets → Notion features → AI context → Code

- Automatic header generation for traceability

- Feature isolation rules to prevent regressions

#### 6. MCP Server Architecture

- Uses `subprocess` to call CLI commands (single source of truth)

- All tools return JSON for consistent parsing

- FastMCP framework for Model Context Protocol

### Important Implementation Details

- The Asana client uses direct HTTP requests instead of the official SDK due to version compatibility issues

- Feature codes follow patterns like AU01, DA02, API03 (prefix + 2-digit number)

- Headers are automatically generated in code files for traceability

- Context files are exported to `AGENTS.md` following the universal AI agent standard

- Heading normalization ensures consistent markdown hierarchy in generated files

### Dependencies

Main dependencies (from requirements.txt):

- `click>=8.1.7` - CLI framework

- `rich>=13.7.0` - Terminal formatting

- `notion-client>=2.2.1` - Notion API

- `requests>=2.31.0` - HTTP requests (for Asana)

- `pyyaml>=6.0.1` - Configuration

- `gitpython>=3.1.40` - Git integration

Optional dependencies (for MCP server):

- `mcp>=1.0.0` - Model Context Protocol

### Configuration

#### Configuration File

Path: `~/.notion-dev/config.yml`

```yaml
notion:
  token: "secret_XXX"
  database_modules_id: "xxx-xxx-xxx"
  database_features_id: "xxx-xxx-xxx"

asana:
  access_token: "1/xxx:xxx"
  workspace_gid: "123456789"
  user_gid: "123456789"
  portfolio_gid: "123456789"  # Optional

github:
  token: "ghp_XXX"  # Optional, for private repos
  clone_dir: "/tmp/notiondev"
  shallow_clone: true

logging:
  level: INFO
  file: notion-dev.log
```

#### Environment Variables

All configuration values can be set via environment variables:

- `NOTION_TOKEN`

- `NOTION_MODULES_DB`

- `NOTION_FEATURES_DB`

- `ASANA_TOKEN`

- `ASANA_WORKSPACE`

- `ASANA_USER`

- `GITHUB_TOKEN`

### Logging

- **File**: `~/.notion-dev/notion-dev.log`

- **Rotation**: 10MB max, 5 backups

- **Console**: Errors only

### Testing

Run tests with pytest:

```bash
pytest tests/unit -v
```

Test coverage includes:

- Unit tests for models (AsanaTask, Feature)

- Context builder tests (AGENTS.md generation, heading normalization)

- MCP server helpers

- Logging configuration with rotation

### Release Process

#### Quick Release (Recommended)

Use the `release.sh` script to automate the entire process:

```bash
./release.sh 1.4.0
```

This script will:

1. Validate the version format (X.Y.Z)

1. Update version in all 3 files (`__init__.py`, `setup.py`, `pyproject.toml`)

---

# 4. RULES & GUIDELINES

## Regression Prevention Rules

⚠️ **CRITICAL**: You are working on feature **ND03** within a larger codebase. Follow these rules strictly:

1. **Feature Isolation**: Work ONLY on feature **ND03**
2. **File Headers Check**: Every file has a header indicating which feature it implements
3. **Modification Rules**:
   - ✅ CREATE new files: MUST add the header for feature ND03
   - ✅ MODIFY files: ONLY if header contains feature ND03
   - ❌ NEVER modify files with different feature codes
   - ❌ NEVER remove or alter existing feature headers

## Mandatory File Headers

Every new file you create MUST start with:
```
/**
 * NOTION FEATURES: ND03
 * MODULES: NotionDev
 * DESCRIPTION: [Brief description of file purpose]
 * LAST_SYNC: 2025-12-30
 */
```

## Before Modifying Existing Files

1. CHECK the file header for NOTION FEATURES
2. ONLY proceed if it contains "ND03"
3. If multiple features listed, ensure ND03 is included
4. NEVER modify if ND03 is not present

## Language Requirements

- **Documentation reading**: You may encounter documentation in various languages
- **Chat responses**: You may respond in the user's preferred language
- **Code and comments**: ALL code, comments, variable names, and function names MUST be in English

## Build and Test Commands

```bash
# Run unit tests
pytest tests/unit -v

# Run CLI in development mode
python -m notion_dev.cli.main

# List Asana tickets
python -m notion_dev.cli.main tickets
```

---

# Project Information

- **Project**: notion_dev-project
- **Repository**: /Users/phf/notion_dev-project
- **Git Status**: Git repository
- **Cache Location**: /Users/phf/notion_dev-project/.notion-dev

---
*Generated by NotionDev - Keeping your code aligned with specifications*
